MODEL_SIZE=${1:-"32b"}
GLOBAL_BATCH_SIZE=-1 
GLOBAL_TOKEN_NUM=${2:-1600000}
MAX_SEQ_LEN=${3:-32768}
ENV_FILE_PATH=${4:-"./scripts/env.sh"}
STRATEGY_POOL=${5:-"./strategy/strategy_pool_32b.json"}

NUM_GPUS=1024
MULTI_TP_PP_LIST="[[(16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1), (16, 1)], [(16, 1), (8, 1), (8, 1), (8, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 1), (4, 4), (4, 4)]]"

# NUM_GPUS=64
# MULTI_TP_PP_LIST="[[(16, 1), (16, 1), (16, 1), (16, 1)], [(16, 1), (8, 1), (8, 1), (8, 1), (8, 1), (8, 1), (8, 1)]]"

# NUM_GPUS=32
# MULTI_TP_PP_LIST="[[(16, 1), (16, 1)], [(16, 1), (2, 2), (1, 4), (1, 4), (1, 4)]]"


ROOT_FOLDER=data
JSON_FILE=${ROOT_FOLDER}/web/combined_data.json
JSON_KEY=content
VOCAB_FILE=${ROOT_FOLDER}/vocab.json
MERGE_FILE=${ROOT_FOLDER}/merges.txt

python3 -u test_planner.py \
--strategy_pool $STRATEGY_POOL \
--multi_tp_pp_list "${MULTI_TP_PP_LIST}" \
--global_batch_size $GLOBAL_BATCH_SIZE \
--global_token_num $GLOBAL_TOKEN_NUM \
--max_seq_len $MAX_SEQ_LEN \
--json_file $JSON_FILE \
--json_key $JSON_KEY \
--vocab_file $VOCAB_FILE \
--merge_file $MERGE_FILE \
--vocab_size 50304 \
--ngpus ${NUM_GPUS}